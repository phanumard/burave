<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Flex Message Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .font-kanit {
            font-family: 'Kanit', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
    <div class="p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">LINE Flex Message Generator</h1>
                <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message JSON</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- Left Column: Form Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    
                    <div class="space-y-4">
                        <!-- Web Link -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Web Link
                                <span id="loadingIndicator" class="ml-2 text-xs text-blue-600 animate-pulse hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                            </label>
                            <div class="flex gap-2">
                                <input
                                    type="url"
                                    id="weblink"
                                    placeholder="https://example.com/article"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                                <button
                                    type="button"
                                    id="btnRefresh"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà"
                                >
                                    üîÑ
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å, ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </p>
                        </div>

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input
                                type="text"
                                id="title"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                        </div>

                        <!-- Product (‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠ Category) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                            <input
                                type="text"
                                id="cat_title"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">üè∑Ô∏è ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å title (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô /)</p>
                        </div>

                        <!-- Image URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                            <input
                                type="text"
                                id="image"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                üñºÔ∏è ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL ‡πÄ‡∏ï‡πá‡∏° / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô GitHub
                            </p>
                        </div>

                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input
                                type="text"
                                id="date"
                                placeholder="01042025"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: DDMMYYYY (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                            </p>
                        </div>

                        <!-- Key Summary (Article only) -->
                        <div id="keysumContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Key Summary</label>
                            <textarea
                                id="keysum"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            ></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å meta description)
                            </p>
                        </div>

                        <!-- Debug Info -->
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <details>
                                <summary class="cursor-pointer text-sm font-medium text-gray-700">üîç Debug Info (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</summary>
                                <div id="debugInfo" class="mt-2 p-2 bg-white rounded text-xs text-gray-600 max-h-40 overflow-auto">
                                    <p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                                </div>
                            </details>
                            <p class="text-xs text-gray-500 mt-2">
                                üí° ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏π Debug Info ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î F12 ‚Üí Console
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Preview Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Preview</h2>
                    <div class="flex justify-center">
                        <div id="previewCard" class="w-full max-w-sm bg-white border border-gray-200 rounded-lg overflow-hidden shadow-md">
                            <!-- Preview will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom: JSON Output Section (Full Width) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">JSON Output</h2>
                    <button
                        id="btnCopy"
                        class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                    >
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        <span id="copyText">Copy</span>
                    </button>
                </div>
                
                <div class="bg-gray-900 rounded-lg p-4 overflow-auto max-h-96">
                    <pre id="jsonOutput" class="text-green-400 text-sm font-mono"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State management
        let fontSize = 18; // Default font size in pixels
        let isLoading = false;

        // Get today's date in DDMMYYYY format
        function getTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}${month}${year}`;
        }

        // Initialize date
        document.getElementById('date').value = getTodayDate();

        // Get form data
        function getFormData() {
            return {
                title: document.getElementById('title').value || '[title]',
                cat_title: document.getElementById('cat_title').value || '',
                image: document.getElementById('image').value || '[image]',
                weblink: document.getElementById('weblink').value || '[weblink]',
                keysum: document.getElementById('keysum').value || '[keysum]',
                date: document.getElementById('date').value || '[date]'
            };
        }

        // Get image URL
        function getImageUrl(image) {
            if (!image || image === '[image]') return '[image]';
            if (image.startsWith('http')) return image;
            return `https://raw.githubusercontent.com/scbeic/sharetarget2/main/${image}`;
        }

        // Get weblink with UTM
        function getWebLinkWithUTM(weblink) {
            if (!weblink || weblink === '[weblink]') return '[weblink]';
            const utmParams = '?utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA';
            return weblink.includes('?') 
                ? weblink + '&utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA'
                : weblink + utmParams;
        }

        // Generate Article JSON
        function generateArticleJSON(data) {
            return [{
                "type": "flex",
                "altText": data.title,
                "contents": {
                    "type": "bubble",
                    "size": "giga",
                    "hero": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "image",
                                "url": getImageUrl(data.image),
                                "size": "full",
                                "aspectRatio": "20:14",
                                "aspectMode": "cover",
                                "action": {
                                    "type": "uri",
                                    "uri": getWebLinkWithUTM(data.weblink)
                                }
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [],
                                "position": "absolute",
                                "background": {
                                    "type": "linearGradient",
                                    "angle": "0deg",
                                    "startColor": "#00000000",
                                    "endColor": "#000000CC"
                                },
                                "width": "100%",
                                "height": "100%",
                                "offsetBottom": "0px",
                                "offsetStart": "0px",
                                "offsetEnd": "0px"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    {
                                        "type": "image",
                                        "url": "https://phanumard.github.io/burave/eic-logo-black.png",
                                        "size": "xs",
                                        "align": "start"
                                    }
                                ],
                                "position": "absolute",
                                "offsetTop": "0px",
                                "offsetStart": "20px",
                                "width": "80px"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": data.title,
                                        "size": `${fontSize}px`,
                                        "color": "#FFFFFF",
                                        "weight": "regular",
                                        "wrap": true,
                                        "style": "normal",
                                        "decoration": "none"
                                    },
                                    {
                                        "type": "box",
                                        "layout": "vertical",
                                        "contents": [
                                            {
                                                "type": "separator",
                                                "color": "#BD8B66",
                                                "margin": "xs"
                                            },
                                            {
                                                "type": "text",
                                                "text": data.cat_title || "",
                                                "size": `${Math.round(fontSize * 0.3)}px`,
                                                "color": "#FFFFFF",
                                                "weight": "regular",
                                                "wrap": true,
                                                "margin": "xs"
                                            }
                                        ],
                                        "margin": "xs",
                                        "width": "auto"
                                    }
                                ],
                                "position": "absolute",
                                "offsetBottom": "18px",
                                "offsetStart": "20px",
                                "offsetEnd": "20px"
                            }
                        ]
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": "Key summary",
                                "weight": "bold",
                                "size": "lg",
                                "margin": "none"
                            },
                            {
                                "type": "text",
                                "text": data.keysum,
                                "size": "sm",
                                "color": "#666666",
                                "margin": "md",
                                "wrap": true
                            }
                        ],
                        "spacing": "md"
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "button",
                                "style": "primary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Read more",
                                    "uri": getWebLinkWithUTM(data.weblink)
                                },
                                "color": "#6B46C1"
                            },
                            {
                                "type": "button",
                                "style": "secondary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Share",
                                    "uri": `https://line.me/R/share?text=${encodeURIComponent(getWebLinkWithUTM(data.weblink))}`
                                }
                            }
                        ],
                        "flex": 0
                    }
                }
            }];
        }

        // Generate JSON
        function generateJSON() {
            const data = getFormData();
            const json = generateArticleJSON(data);
            return JSON.stringify(json, null, 2);
        }

        // Update preview
        function updatePreview() {
            const data = getFormData();
            const imageUrl = getImageUrl(data.image);

            const html = `
                <div class="relative h-64 bg-gray-100">
                    ${imageUrl !== '[image]' ? `
                        <img 
                            src="${imageUrl}"
                            alt="${data.title}"
                            class="absolute inset-0 w-full h-full object-cover"
                            onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'absolute inset-0 flex items-center justify-center text-gray-400\\'>Image Preview</div>';"
                        />
                        <!-- Gradient Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                        <!-- Logo at Top Left (aligned with body padding) -->
                        <div class="absolute top-0 left-5 w-20 pt-4">
                            <img src="https://phanumard.github.io/burave/eic-logo-black.png" alt="EIC Logo" class="w-full" />
                        </div>
                        <!-- Title Text at Bottom Left (aligned with body padding) - ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ -->
                        <div class="absolute bottom-[18px] left-5 right-5">
                            <p class="font-kanit text-white" style="font-size: ${fontSize}px; line-height: 1.3; font-weight: 500;">
                                ${data.title}
                            </p>
                            ${data.cat_title ? `
                                <div class="mt-1 inline-block">
                                    <div class="h-px mb-1" style="background-color: #BD8B66;"></div>
                                    <p class="text-white" style="font-size: ${Math.round(fontSize * 0.3)}px; font-weight: 400;">
                                        ${data.cat_title}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                            Image Preview
                        </div>
                    `}
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-lg mb-3">Key summary</h3>
                    <p class="text-gray-600 text-sm">${data.keysum}</p>
                </div>
                <div class="p-5 space-y-2">
                    <button class="w-full py-2 text-white rounded font-medium transition-colors bg-purple-700 hover:bg-purple-800">
                        Read more
                    </button>
                    <button class="w-full py-2 bg-gray-200 text-gray-700 rounded font-medium hover:bg-gray-300 transition-colors">
                        Share
                    </button>
                </div>
            `;

            document.getElementById('previewCard').innerHTML = html;
        }

        // Update all outputs
        function updateOutputs() {
            document.getElementById('jsonOutput').textContent = generateJSON();
            updatePreview();
        }

        // Add debug message to UI
        function addDebugMessage(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600';
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            debugInfo.innerHTML = `<p class="${color}">[${timestamp}] ${icon} ${message}</p>` + debugInfo.innerHTML;
        }

        // Fetch metadata from URL
        async function fetchMetadata(url) {
            if (!url || !url.startsWith('http')) return;
            
            isLoading = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('btnRefresh').disabled = true;

            console.log('Fetching metadata from:', url);
            addDebugMessage(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å: ${url}`);

            try {
                // Try Method 1: Microlink API
                try {
                    console.log('Trying Microlink API...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Microlink API...');
                    
                    const microlinkUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
                    const response = await fetch(microlinkUrl);
                    
                    console.log('Microlink response status:', response.status);
                    addDebugMessage(`Microlink API status: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Microlink data:', result);
                        const data = result.data;
                        
                        if (data) {
                            let imageFound = false;
                            let descriptionFound = false;
                            let titleFound = false;
                            
                            // Get TITLE from Microlink
                            if (data.title && !document.getElementById('title').value) {
                                let titleToUse = data.title;
                                
                                // Extract product/category and clean title
                                // Format: "category / title | site"
                                if (titleToUse.includes('/') && titleToUse.includes('|')) {
                                    const parts = titleToUse.split('/');
                                    if (parts.length >= 2) {
                                        // Product = part before "/"
                                        const product = parts[0].trim();
                                        document.getElementById('cat_title').value = product;
                                        console.log('‚úÖ Product extracted:', product);
                                        addDebugMessage(`Product: ${product}`, 'success');
                                        
                                        // Title = part between "/" and "|"
                                        titleToUse = parts[1].split('|')[0].trim();
                                    }
                                }
                                
                                document.getElementById('title').value = titleToUse;
                                titleFound = true;
                                console.log('‚úÖ Title found from Microlink:', titleToUse);
                                addDebugMessage(`‡∏ä‡∏∑‡πà‡∏≠ (‡∏à‡∏≤‡∏Å Microlink): ${titleToUse}`, 'success');
                            }
                            
                            if (data.image?.url || data.logo?.url) {
                                document.getElementById('image').value = data.image?.url || data.logo?.url;
                                imageFound = true;
                                console.log('Image found:', data.image?.url || data.logo?.url);
                                addDebugMessage(`‡∏†‡∏≤‡∏û: ${data.image?.url || data.logo?.url}`, 'success');
                            }
                            
                            if (data.description) {
                                document.getElementById('keysum').value = data.description;
                                descriptionFound = true;
                                console.log('Description found:', data.description);
                                addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${data.description.substring(0, 50)}...`, 'success');
                            }
                            
                            // If we got title from Microlink, we can skip AllOrigins
                            if (titleFound && imageFound && descriptionFound) {
                                console.log('‚úÖ Got all data from Microlink, skipping AllOrigins');
                                addDebugMessage('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏à‡∏≤‡∏Å Microlink ‡πÅ‡∏•‡πâ‡∏ß', 'success');
                                updateOutputs();
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.log('‚ùå Microlink API error:', e.message);
                    addDebugMessage(`Microlink API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // Try Method 2: LinkPreview API for image and description
                try {
                    console.log('Trying LinkPreview API...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ LinkPreview API...');
                    
                    const linkPreviewUrl = `https://api.linkpreview.net/?q=${encodeURIComponent(url)}`;
                    const response = await fetch(linkPreviewUrl);
                    
                    console.log('LinkPreview response status:', response.status);
                    addDebugMessage(`LinkPreview API status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('LinkPreview data:', data);
                        
                        if (data.image && !document.getElementById('image').value) {
                            document.getElementById('image').value = data.image;
                            console.log('Image found:', data.image);
                            addDebugMessage(`‡∏†‡∏≤‡∏û: ${data.image}`, 'success');
                        }
                        if (data.description && !document.getElementById('keysum').value) {
                            document.getElementById('keysum').value = data.description;
                            console.log('Description found:', data.description);
                            addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${data.description.substring(0, 50)}...`, 'success');
                        }
                    }
                } catch (e) {
                    console.log('‚ùå LinkPreview API error:', e.message);
                    addDebugMessage(`LinkPreview API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // ALWAYS try Method 3: AllOrigins to get h1 tag for title and category
                try {
                    console.log('Trying AllOrigins proxy...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ AllOrigins Proxy...');
                    
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    console.log('AllOrigins response status:', response.status);
                    addDebugMessage(`AllOrigins status: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const html = result.contents;
                        
                        // Parse HTML to extract meta tags
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        let updated = false;
                        
                        console.log('=== Starting metadata extraction ===');
                        
                        // === EXTRACT TITLE ===
                        // Priority 1: Try from h1 tags in HTML
                        const allH1 = doc.querySelectorAll('h1');
                        console.log('üîç Found h1 tags:', allH1.length);
                        
                        let h1Text = null;
                        if (allH1.length > 0) {
                            allH1.forEach((h1, index) => {
                                const text = h1.textContent?.trim();
                                console.log(`  h1[${index}]:`, text?.substring(0, 150));
                                
                                // Get the first non-empty h1 that's not too short
                                if (!h1Text && text && text.length > 10) {
                                    h1Text = text;
                                }
                            });
                        }
                        
                        console.log('üìù h1Text from HTML:', h1Text);
                        
                        // Priority 2: Try og:title
                        const ogTitle = doc.querySelector('meta[property="og:title"]')?.content || 
                                       doc.querySelector('meta[name="twitter:title"]')?.content;
                        console.log('üìù og:title:', ogTitle);
                        
                        // Priority 3: Extract from page title (format: "category / title | site")
                        const pageTitle = doc.querySelector('title')?.textContent?.trim();
                        console.log('üìù page title:', pageTitle);
                        
                        let titleFromPageTitle = null;
                        let productFromPageTitle = null;
                        
                        if (pageTitle && pageTitle.includes('/') && pageTitle.includes('|')) {
                            const parts = pageTitle.split('/');
                            if (parts.length >= 2) {
                                productFromPageTitle = parts[0].trim();
                                titleFromPageTitle = parts[1].split('|')[0].trim();
                                console.log('üìù product extracted from page title:', productFromPageTitle);
                                console.log('üìù title extracted from page title:', titleFromPageTitle);
                            }
                        }
                        
                        // Choose the best title
                        const titleToUse = h1Text || ogTitle || titleFromPageTitle || pageTitle;
                        const productToUse = productFromPageTitle;
                        
                        console.log('‚úÖ Final title to use:', titleToUse);
                        console.log('‚úÖ Final product to use:', productToUse);
                        
                        // === EXTRACT IMAGE & DESCRIPTION ===
                        const ogImage = doc.querySelector('meta[property="og:image"]')?.content || 
                                       doc.querySelector('meta[name="twitter:image"]')?.content;
                        const ogDescription = doc.querySelector('meta[property="og:description"]')?.content ||
                                             doc.querySelector('meta[name="twitter:description"]')?.content ||
                                             doc.querySelector('meta[name="description"]')?.content;
                        
                        console.log('Extracted data:', {
                            h1: h1Text,
                            ogTitle: ogTitle,
                            finalTitle: titleToUse,
                            product: productToUse,
                            image: ogImage,
                            description: ogDescription
                        });
                        
                        // === UPDATE FORM FIELDS ===
                        if (ogImage && !document.getElementById('image').value) {
                            document.getElementById('image').value = ogImage;
                            updated = true;
                            console.log('‚úÖ Image updated');
                            addDebugMessage(`‡∏†‡∏≤‡∏û: ${ogImage}`, 'success');
                        }
                        if (titleToUse && !document.getElementById('title').value) {
                            document.getElementById('title').value = titleToUse;
                            updated = true;
                            const source = h1Text ? 'h1' : ogTitle ? 'og:title' : 'page title';
                            console.log(`‚úÖ Title updated from ${source}:`, titleToUse);
                            addDebugMessage(`‡∏ä‡∏∑‡πà‡∏≠ (‡∏à‡∏≤‡∏Å ${source}): ${titleToUse}`, 'success');
                        } else if (!titleToUse) {
                            console.log('‚ùå No title found');
                            addDebugMessage('Title: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                        }
                        if (productToUse && !document.getElementById('cat_title').value) {
                            document.getElementById('cat_title').value = productToUse;
                            updated = true;
                            console.log('‚úÖ Product updated:', productToUse);
                            addDebugMessage(`Product: ${productToUse}`, 'success');
                        }
                        if (ogDescription && !document.getElementById('keysum').value) {
                            document.getElementById('keysum').value = ogDescription;
                            updated = true;
                            console.log('Description found:', ogDescription);
                            addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${ogDescription.substring(0, 50)}...`, 'success');
                        }
                        
                        if (updated) {
                            updateOutputs();
                            console.log('‚úÖ Successfully fetched metadata from AllOrigins');
                            addDebugMessage('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å AllOrigins Proxy', 'success');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('‚ùå AllOrigins proxy error:', e.message);
                    addDebugMessage(`AllOrigins Proxy ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // Check if we got any data at all before showing error
                const hasImage = document.getElementById('image').value;
                const hasTitle = document.getElementById('title').value;
                const hasDescription = document.getElementById('keysum').value;
                
                if (hasImage || hasTitle || hasDescription) {
                    updateOutputs();
                    addDebugMessage('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    return;
                }

                console.log('‚ùå All methods failed - no data retrieved');
                addDebugMessage('‚ùå ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á', 'error');
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n1. ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ h1 ‡∏´‡∏£‡∏∑‡∏≠ meta tags\n2. ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Ñ API requests\n3. API ‡∏°‡∏µ rate limit\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á\n\n‡∏î‡∏π Debug Info ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
                
            } finally {
                isLoading = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('btnRefresh').disabled = false;
            }
        }
        // Event listeners
        document.getElementById('weblink').addEventListener('input', function(e) {
            if (e.target.value) {
                fetchMetadata(e.target.value);
            }
        });

        document.getElementById('btnRefresh').addEventListener('click', function() {
            const url = document.getElementById('weblink').value;
            if (url) {
                fetchMetadata(url);
            }
        });

        document.getElementById('title').addEventListener('input', updateOutputs);
        document.getElementById('cat_title').addEventListener('input', updateOutputs);
        document.getElementById('image').addEventListener('input', updateOutputs);
        document.getElementById('date').addEventListener('input', updateOutputs);
        document.getElementById('keysum').addEventListener('input', updateOutputs);

        document.getElementById('btnCopy').addEventListener('click', function() {
            const jsonOutput = generateJSON();
            navigator.clipboard.writeText(jsonOutput).then(() => {
                const icon = this.querySelector('i');
                const text = document.getElementById('copyText');
                
                icon.setAttribute('data-lucide', 'check');
                text.textContent = 'Copied!';
                lucide.createIcons();
                
                setTimeout(() => {
                    icon.setAttribute('data-lucide', 'copy');
                    text.textContent = 'Copy';
                    lucide.createIcons();
                }, 2000);
            });
        });

        // Initial render
        updateOutputs();
    </script>
</body>
</html>
