<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCB EIC Artwork Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .font-kanit {
            font-family: 'Kanit', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
    <div class="p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">SCB EIC Artwork Generator</h1>
                <p class="text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡πÅ‡∏•‡∏∞ Export ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SCB EIC</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- Left Column: Form Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    
                    <div class="space-y-4">
                        <!-- Web Link -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Web Link
                                <span id="loadingIndicator" class="ml-2 text-xs text-blue-600 animate-pulse hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                            </label>
                            <div class="flex gap-2">
                                <input
                                    type="url"
                                    id="weblink"
                                    placeholder="https://www.scbeic.com/th/detail/product/..."
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                                <button
                                    type="button"
                                    id="btnRefresh"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà"
                                >
                                    üîÑ
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å, ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </p>
                        </div>

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Title
                                <span class="ml-2 text-xs text-blue-600">üí° Tips: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Kanit font ‡πÉ‡∏´‡πâ‡∏Å‡∏î Export Image ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô</span>
                            </label>
                            <div class="relative">
                                <textarea
                                    id="title"
                                    placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                    rows="2"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                ></textarea>
                                <div class="flex gap-2 mt-2">
                                    <button
                                        type="button"
                                        id="btnSmartBreak"
                                        class="flex-1 px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-sm"
                                        title="‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ / ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß"
                                    >
                                        ‚ú® Smart Break
                                    </button>
                                    <button
                                        type="button"
                                        id="btnAddLineBreak"
                                        class="px-3 py-1.5 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-colors shadow-sm"
                                        title="‡πÄ‡∏û‡∏¥‡πà‡∏° line break ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á cursor"
                                    >
                                        ‚Ü©Ô∏è Add \n
                                    </button>
                                    <button
                                        type="button"
                                        id="btnClearBreaks"
                                        class="px-3 py-1.5 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition-colors shadow-sm"
                                        title="‡∏•‡∏ö line breaks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                                    >
                                        üóëÔ∏è Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea
                                id="description"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            ></textarea>
                        </div>

                        <!-- Image URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                            <input
                                type="url"
                                id="image"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-2 pt-4">
                            <button
                                type="button"
                                id="btnCopy"
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                            >
                                <i data-lucide="copy"></i>
                                <span>Copy JSON</span>
                            </button>
                            <button
                                type="button"
                                id="btnExportImage"
                                class="flex-1 bg-gradient-to-r from-green-600 to-teal-600 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-teal-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                            >
                                <i data-lucide="download"></i>
                                <span>Export Image</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Preview Section -->
                <div class="space-y-6">
                    <!-- Image Preview -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Image Preview (Kanit Font)</h3>
                        <div id="imagePreviewSection" class="bg-white rounded-lg overflow-hidden" style="width: 350px; margin: 0 auto;">
                            <!-- Image Container -->
                            <div class="relative w-full" style="height: 197px;">
                                <img id="previewImage" src="" alt="" class="w-full h-full object-cover" style="display: none;">
                                <div id="placeholderImage" class="w-full h-full bg-gray-200 flex items-center justify-center">
                                    <span class="text-gray-400 text-sm">No Image</span>
                                </div>
                            </div>
                            
                            <!-- Text Container -->
                            <div class="px-4 py-3">
                                <!-- Title -->
                                <div id="previewTitle" class="font-kanit text-gray-800 mb-2" style="font-weight: 600; font-size: 15px; line-height: 1.4; white-space: pre-wrap;"></div>
                                
                                <!-- Description -->
                                <div id="previewDescription" class="font-kanit text-gray-600" style="font-weight: 400; font-size: 12px; line-height: 1.5;"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3 text-center">
                            ‚ö†Ô∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Kanit font - Export ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô LINE
                        </p>
                    </div>

                    <!-- JSON Preview -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Flex Message JSON</h3>
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre id="jsonOutput" class="text-green-400 text-xs font-mono"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // ===== UTILITY FUNCTIONS =====
        
        // Get form data
        function getFormData() {
            return {
                title: document.getElementById('title').value.trim() || '[title]',
                description: document.getElementById('description').value.trim() || '[description]',
                image: document.getElementById('image').value.trim() || '[image]',
                weblink: document.getElementById('weblink').value.trim() || 'https://example.com'
            };
        }
        
        // Generate Flex Message JSON
        function generateFlexJSON(data) {
            return {
                "type": "bubble",
                "hero": {
                    "type": "image",
                    "url": data.image,
                    "size": "full",
                    "aspectRatio": "16:9",
                    "aspectMode": "cover",
                    "action": {
                        "type": "uri",
                        "uri": data.weblink
                    }
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": data.title,
                            "weight": "bold",
                            "size": "md",
                            "wrap": true
                        },
                        {
                            "type": "text",
                            "text": data.description,
                            "size": "xs",
                            "color": "#666666",
                            "wrap": true,
                            "margin": "md"
                        }
                    ]
                },
                "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "button",
                            "style": "primary",
                            "height": "sm",
                            "action": {
                                "type": "uri",
                                "label": "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠",
                                "uri": data.weblink
                            },
                            "color": "#4E2A84"
                        }
                    ],
                    "flex": 0
                }
            };
        }
        
        // Update all outputs (JSON and Image Preview)
        function updateOutputs() {
            const data = getFormData();
            
            // Update JSON output
            const jsonOutput = document.getElementById('jsonOutput');
            const flexJSON = generateFlexJSON(data);
            jsonOutput.textContent = JSON.stringify(flexJSON, null, 2);
            
            // Update Image Preview
            updateImagePreview(data);
        }
        
        // Update Image Preview with Kanit font
        function updateImagePreview(data) {
            const previewImage = document.getElementById('previewImage');
            const placeholderImage = document.getElementById('placeholderImage');
            const previewTitle = document.getElementById('previewTitle');
            const previewDescription = document.getElementById('previewDescription');
            
            // Update image
            if (data.image && data.image !== '[image]') {
                previewImage.src = data.image;
                previewImage.style.display = 'block';
                placeholderImage.style.display = 'none';
            } else {
                previewImage.style.display = 'none';
                placeholderImage.style.display = 'flex';
            }
            
            // Update title with Kanit font
            previewTitle.textContent = data.title;
            
            // Update description with Kanit font
            previewDescription.textContent = data.description;
        }
        
        // ===== COPY JSON FUNCTION =====
        
        // Copy JSON to clipboard
        async function copyJSON() {
            const jsonOutput = document.getElementById('jsonOutput');
            const button = document.getElementById('btnCopy');
            const buttonText = button.querySelector('span');
            const buttonIcon = button.querySelector('i');
            
            try {
                await navigator.clipboard.writeText(jsonOutput.textContent);
                
                // Update button to success state
                buttonText.textContent = 'Copied!';
                buttonIcon.setAttribute('data-lucide', 'check');
                lucide.createIcons();
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    buttonText.textContent = 'Copy JSON';
                    buttonIcon.setAttribute('data-lucide', 'copy');
                    lucide.createIcons();
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ copy ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }
        
        // ===== WEB SCRAPING FUNCTION =====
        
        // Fetch metadata from URL
        async function fetchMetadata() {
            const weblinkInput = document.getElementById('weblink');
            const url = weblinkInput.value.trim();
            
            if (!url) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Validate URL
            try {
                new URL(url);
            } catch (e) {
                alert('URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                return;
            }
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            const btnRefresh = document.getElementById('btnRefresh');
            
            try {
                // Show loading state
                loadingIndicator.classList.remove('hidden');
                btnRefresh.disabled = true;
                
                console.log('üîç Fetching metadata from:', url);
                
                // Use CORS proxy
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (!data.contents) {
                    throw new Error('No content received');
                }
                
                // Parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                
                console.log('‚úÖ HTML parsed successfully');
                
                // Extract metadata
                let title = '';
                let description = '';
                let image = '';
                
                // Try multiple selectors for title
                title = doc.querySelector('meta[property="og:title"]')?.getAttribute('content') ||
                       doc.querySelector('meta[name="twitter:title"]')?.getAttribute('content') ||
                       doc.querySelector('title')?.textContent ||
                       doc.querySelector('h1')?.textContent ||
                       '';
                
                // Try multiple selectors for description
                description = doc.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
                             doc.querySelector('meta[name="twitter:description"]')?.getAttribute('content') ||
                             doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
                             '';
                
                // Try multiple selectors for image
                image = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') ||
                       doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content') ||
                       doc.querySelector('img')?.getAttribute('src') ||
                       '';
                
                // Make image URL absolute if it's relative
                if (image && !image.startsWith('http')) {
                    const urlObj = new URL(url);
                    if (image.startsWith('/')) {
                        image = urlObj.origin + image;
                    } else {
                        image = urlObj.origin + '/' + image;
                    }
                }
                
                console.log('üìù Extracted metadata:', { title, description, image });
                
                // Update form fields
                if (title) document.getElementById('title').value = title;
                if (description) document.getElementById('description').value = description;
                if (image) document.getElementById('image').value = image;
                
                // Update outputs
                updateOutputs();
                
                console.log('‚úÖ Metadata loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error fetching metadata:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á');
            } finally {
                // Hide loading state
                loadingIndicator.classList.add('hidden');
                btnRefresh.disabled = false;
            }
        }
        
        // ===== SMART BREAK FUNCTIONS =====
        
        // Smart Break: ‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        function smartBreak() {
            const titleInput = document.getElementById('title');
            let text = titleInput.value.trim();
            
            if (!text) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Title ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Strategy 1: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏° / (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (text.includes('/')) {
                text = text.replace(/\s*\/\s*/g, '\n');
                titleInput.value = text;
                updateOutputs();
                console.log('‚úÖ Smart Break: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ /');
                return;
            }
            
            // Strategy 2: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ | (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (text.includes('|')) {
                text = text.replace(/\s*\|\s*/g, '\n');
                titleInput.value = text;
                updateOutputs();
                console.log('‚úÖ Smart Break: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ |');
                return;
            }
            
            // Strategy 3: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
            if (text.length > 40) {
                // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                const mid = Math.floor(text.length / 2);
                let breakPoint = -1;
                let minDistance = Infinity;
                
                // ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                for (let i = 0; i < text.length; i++) {
                    if (text[i] === ' ') {
                        const distance = Math.abs(i - mid);
                        if (distance < minDistance) {
                            minDistance = distance;
                            breakPoint = i;
                        }
                    }
                }
                
                if (breakPoint !== -1) {
                    text = text.substring(0, breakPoint) + '\n' + text.substring(breakPoint + 1);
                    titleInput.value = text;
                    updateOutputs();
                    console.log('‚úÖ Smart Break: ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß');
                    return;
                }
            }
            
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î\n‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ "Add \\n" ‡πÅ‡∏ó‡∏ô');
        }
        
        // Add Line Break: ‡πÄ‡∏û‡∏¥‡πà‡∏° \n ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á cursor
        function addLineBreak() {
            const titleInput = document.getElementById('title');
            const start = titleInput.selectionStart;
            const end = titleInput.selectionEnd;
            const text = titleInput.value;
            
            // ‡πÅ‡∏ó‡∏£‡∏Å \n ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á cursor
            titleInput.value = text.substring(0, start) + '\n' + text.substring(end);
            
            // ‡∏¢‡πâ‡∏≤‡∏¢ cursor ‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á \n
            titleInput.selectionStart = titleInput.selectionEnd = start + 1;
            titleInput.focus();
            
            updateOutputs();
            console.log('‚úÖ Added line break at position:', start);
        }
        
        // Clear Breaks: ‡∏•‡∏ö line breaks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function clearLineBreaks() {
            const titleInput = document.getElementById('title');
            titleInput.value = titleInput.value.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            updateOutputs();
            console.log('‚úÖ Cleared all line breaks');
        }
        
        // ===== EXPORT IMAGE FUNCTION WITH CORS FIX =====
        
        // Convert image URL to base64 using CORS proxy
        async function imageUrlToBase64(url) {
            try {
                console.log('üîÑ Converting image to base64:', url);
                
                // Use CORS proxy to fetch the image
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('‚ùå Error converting image to base64:', error);
                throw error;
            }
        }
        
        // Export ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Image ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ
        async function exportImage() {
            const imageSection = document.getElementById('imagePreviewSection');
            
            if (!imageSection) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô preview ‡∏ó‡∏µ‡πà‡∏à‡∏∞ export');
                return;
            }
            
            // Check if there's an image
            const data = getFormData();
            if (!data.image || data.image === '[image]') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Image URL ‡∏Å‡πà‡∏≠‡∏ô export');
                return;
            }
            
            const button = document.getElementById('btnExportImage');
            const buttonText = button.querySelector('span');
            const buttonIcon = button.querySelector('i');
            const originalText = buttonText ? buttonText.textContent : 'Export Image';
            
            try {
                // Update button state
                button.disabled = true;
                if (buttonText) buttonText.textContent = 'Loading...';
                if (buttonIcon) {
                    buttonIcon.setAttribute('data-lucide', 'loader');
                    lucide.createIcons();
                }
                
                console.log('üé® Starting image export...');
                console.log('Image URL:', data.image);
                
                // Convert external image to base64 to avoid CORS issues
                const previewImage = document.getElementById('previewImage');
                const originalSrc = previewImage.src;
                
                try {
                    if (buttonText) buttonText.textContent = 'Converting...';
                    const base64Image = await imageUrlToBase64(data.image);
                    previewImage.src = base64Image;
                    console.log('‚úÖ Image converted to base64');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not convert image to base64, using original URL');
                    // Continue with original URL if conversion fails
                }
                
                // Wait for image to be applied
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (buttonText) buttonText.textContent = 'Capturing...';
                
                // Use html2canvas to capture the element
                const canvas = await html2canvas(imageSection, {
                    backgroundColor: '#ffffff',
                    scale: 4, // Very high quality (4x resolution)
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    imageTimeout: 0,
                    foreignObjectRendering: false
                });
                
                console.log('‚úÖ Canvas created:', canvas.width, 'x', canvas.height, 'pixels');
                
                // Restore original image URL
                if (originalSrc !== previewImage.src) {
                    previewImage.src = originalSrc;
                }
                
                // Convert canvas to blob
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á image blob ‡πÑ‡∏î‡πâ');
                    }
                    
                    console.log('‚úÖ Blob created, size:', Math.round(blob.size / 1024), 'KB');
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate filename
                    const date = new Date();
                    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                    const timeStr = date.toTimeString().slice(0, 8).replace(/:/g, '');
                    const filename = `scb-eic-artwork-${dateStr}-${timeStr}.png`;
                    
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Revoke URL after download
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    console.log('‚úÖ Image exported successfully:', filename);
                    
                    // Update button to success state
                    if (buttonText) buttonText.textContent = 'Exported!';
                    if (buttonIcon) {
                        buttonIcon.setAttribute('data-lucide', 'check');
                        lucide.createIcons();
                    }
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        button.disabled = false;
                        if (buttonText) buttonText.textContent = originalText;
                        if (buttonIcon) {
                            buttonIcon.setAttribute('data-lucide', 'download');
                            lucide.createIcons();
                        }
                    }, 2000);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                console.error('Error stack:', error.stack);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ export ‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà\n\nError: ' + error.message);
                
                // Reset button on error
                button.disabled = false;
                if (buttonText) buttonText.textContent = originalText;
                if (buttonIcon) {
                    buttonIcon.setAttribute('data-lucide', 'download');
                    lucide.createIcons();
                }
            }
        }
        
        // ===== EVENT LISTENERS =====
        
        // Input change listeners
        document.getElementById('title').addEventListener('input', updateOutputs);
        document.getElementById('description').addEventListener('input', updateOutputs);
        document.getElementById('image').addEventListener('input', updateOutputs);
        document.getElementById('weblink').addEventListener('input', updateOutputs);
        
        // Button listeners
        document.getElementById('btnCopy').addEventListener('click', copyJSON);
        document.getElementById('btnExportImage').addEventListener('click', exportImage);
        document.getElementById('btnRefresh').addEventListener('click', fetchMetadata);
        document.getElementById('btnSmartBreak').addEventListener('click', smartBreak);
        document.getElementById('btnAddLineBreak').addEventListener('click', addLineBreak);
        document.getElementById('btnClearBreaks').addEventListener('click', clearLineBreaks);
        
        // Auto-fetch on URL input (with debounce)
        let fetchTimeout;
        document.getElementById('weblink').addEventListener('input', function() {
            clearTimeout(fetchTimeout);
            const url = this.value.trim();
            if (url && url.startsWith('http')) {
                fetchTimeout = setTimeout(() => {
                    fetchMetadata();
                }, 1000); // Wait 1 second after typing stops
            }
        });
        
        // Initialize outputs on page load
        updateOutputs();
        
        console.log('‚úÖ SCB EIC Artwork Generator initialized');
    </script>
</body>
</html>
