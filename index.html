<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Flex Message Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
    <div class="p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">LINE Flex Message Generator</h1>
                <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message JSON</p>
            </div>

            <!-- Template Type Selector -->
            <div class="mb-8 flex justify-center">
                <div class="bg-white rounded-lg shadow-lg p-2 inline-flex gap-2">
                    <button id="btnArticle" class="px-8 py-3 rounded-lg font-semibold transition-all bg-purple-600 text-white shadow-md">
                        Article
                    </button>
                    <button id="btnOutlook" class="px-8 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200">
                        Outlook
                    </button>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Form Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    
                    <div class="space-y-4">
                        <!-- Web Link -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Web Link
                                <span id="loadingIndicator" class="ml-2 text-xs text-blue-600 animate-pulse hidden">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                            </label>
                            <div class="flex gap-2">
                                <input
                                    type="url"
                                    id="weblink"
                                    placeholder="https://example.com/article"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                                <button
                                    type="button"
                                    id="btnRefresh"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà"
                                >
                                    üîÑ
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å, ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </p>
                        </div>

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input
                                type="text"
                                id="title"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                        </div>

                        <!-- Image URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                            <input
                                type="text"
                                id="image"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                üñºÔ∏è ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL ‡πÄ‡∏ï‡πá‡∏° / ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô GitHub
                            </p>
                        </div>

                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input
                                type="text"
                                id="date"
                                placeholder="01042025"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: DDMMYYYY (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                            </p>
                        </div>

                        <!-- Key Summary (Article only) -->
                        <div id="keysumContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Key Summary</label>
                            <textarea
                                id="keysum"
                                placeholder="‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Web Link ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á"
                                rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            ></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å meta description)
                            </p>
                        </div>

                        <!-- Debug Info -->
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <details>
                                <summary class="cursor-pointer text-sm font-medium text-gray-700">üîç Debug Info (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</summary>
                                <div id="debugInfo" class="mt-2 p-2 bg-white rounded text-xs text-gray-600 max-h-40 overflow-auto">
                                    <p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                                </div>
                            </details>
                            <p class="text-xs text-gray-500 mt-2">
                                üí° ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏π Debug Info ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î F12 ‚Üí Console
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Output Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">JSON Output</h2>
                        <button
                            id="btnCopy"
                            class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span id="copyText">Copy</span>
                        </button>
                    </div>
                    
                    <div class="bg-gray-900 rounded-lg p-4 overflow-auto max-h-[600px]">
                        <pre id="jsonOutput" class="text-green-400 text-sm font-mono"></pre>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Preview</h2>
                <div class="flex justify-center">
                    <div id="previewCard" class="w-full max-w-sm bg-white border border-gray-200 rounded-lg overflow-hidden shadow-md">
                        <!-- Preview will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State management
        let templateType = 'article';
        let isLoading = false;

        // Get today's date in DDMMYYYY format
        function getTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}${month}${year}`;
        }

        // Initialize date
        document.getElementById('date').value = getTodayDate();

        // Get form data
        function getFormData() {
            return {
                title: document.getElementById('title').value || '[title]',
                image: document.getElementById('image').value || '[image]',
                weblink: document.getElementById('weblink').value || '[weblink]',
                keysum: document.getElementById('keysum').value || '[keysum]',
                date: document.getElementById('date').value || '[date]'
            };
        }

        // Get image URL
        function getImageUrl(image) {
            if (!image || image === '[image]') return '[image]';
            if (image.startsWith('http')) return image;
            return `https://raw.githubusercontent.com/scbeic/sharetarget2/main/${image}`;
        }

        // Get weblink with UTM
        function getWebLinkWithUTM(weblink) {
            if (!weblink || weblink === '[weblink]') return '[weblink]';
            const utmParams = '?utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA';
            return weblink.includes('?') 
                ? weblink + '&utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA'
                : weblink + utmParams;
        }

        // Generate Article JSON
        function generateArticleJSON(data) {
            return [{
                "type": "flex",
                "altText": data.title,
                "contents": {
                    "type": "bubble",
                    "size": "giga",
                    "hero": {
                        "type": "image",
                        "url": getImageUrl(data.image),
                        "size": "full",
                        "aspectRatio": "20:14",
                        "aspectMode": "cover",
                        "action": {
                            "type": "uri",
                            "uri": getWebLinkWithUTM(data.weblink)
                        }
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": "Key summary",
                                "weight": "bold",
                                "size": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "margin": "lg",
                                "spacing": "sm",
                                "contents": [
                                    {
                                        "type": "box",
                                        "layout": "baseline",
                                        "spacing": "sm",
                                        "contents": [
                                            {
                                                "type": "text",
                                                "text": data.keysum,
                                                "wrap": true,
                                                "color": "#666666",
                                                "size": "sm",
                                                "flex": 5
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "button",
                                "style": "primary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Read more",
                                    "uri": getWebLinkWithUTM(data.weblink)
                                },
                                "color": "#4e2e79"
                            },
                            {
                                "type": "button",
                                "style": "secondary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Share",
                                    "uri": `https://liff.line.me/1657155025-N4RBzQGX?messages=https://raw.githubusercontent.com/scbeic/sharetarget2/main/messages${data.date}.json`
                                }
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [],
                                "margin": "sm"
                            }
                        ],
                        "flex": 0
                    }
                }
            }];
        }

        // Generate Outlook JSON
        function generateOutlookJSON(data) {
            return [{
                "type": "flex",
                "altText": data.title,
                "contents": {
                    "type": "bubble",
                    "size": "giga",
                    "hero": {
                        "type": "image",
                        "url": getImageUrl(data.image),
                        "size": "full",
                        "aspectRatio": "25:28",
                        "aspectMode": "cover",
                        "action": {
                            "type": "uri",
                            "uri": getWebLinkWithUTM(data.weblink)
                        }
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            {
                                "type": "button",
                                "style": "primary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Read more",
                                    "uri": data.weblink
                                },
                                "color": "#bd8c66"
                            },
                            {
                                "type": "button",
                                "style": "secondary",
                                "height": "sm",
                                "action": {
                                    "type": "uri",
                                    "label": "Share",
                                    "uri": `https://liff.line.me/1657155025-N4RBzQGX?messages=https://raw.githubusercontent.com/scbeic/sharetarget2/main/messages${data.date}.json`
                                }
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [],
                                "margin": "sm"
                            }
                        ],
                        "flex": 0,
                        "backgroundColor": "#1f172b"
                    }
                }
            }];
        }

        // Generate JSON output
        function generateJSON() {
            const data = getFormData();
            const json = templateType === 'article' 
                ? generateArticleJSON(data) 
                : generateOutlookJSON(data);
            return JSON.stringify(json, null, 2);
        }

        // Update preview
        function updatePreview() {
            const data = getFormData();
            const imageUrl = getImageUrl(data.image);
            const aspectRatio = templateType === 'article' ? '70%' : '112%';
            
            let html = `
                <div class="relative bg-gray-200" style="padding-bottom: ${aspectRatio}">
                    ${data.image !== '[image]' ? `
                        <img 
                            src="${imageUrl}"
                            alt="${data.title}"
                            class="absolute inset-0 w-full h-full object-cover"
                            onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'absolute inset-0 flex items-center justify-center text-gray-400\\'>Image Preview</div>';"
                        />
                    ` : `
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                            Image Preview
                        </div>
                    `}
                </div>
            `;

            if (templateType === 'article') {
                html += `
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-3">Key summary</h3>
                        <p class="text-gray-600 text-sm">${data.keysum}</p>
                    </div>
                `;
            }

            const bgColor = templateType === 'outlook' ? 'bg-gray-900' : '';
            const btnColor = templateType === 'article' ? 'bg-purple-700 hover:bg-purple-800' : 'bg-amber-700 hover:bg-amber-800';
            
            html += `
                <div class="p-4 space-y-2 ${bgColor}">
                    <button class="w-full py-2 text-white rounded font-medium transition-colors ${btnColor}">
                        Read more
                    </button>
                    <button class="w-full py-2 bg-gray-200 text-gray-700 rounded font-medium hover:bg-gray-300 transition-colors">
                        Share
                    </button>
                </div>
            `;

            document.getElementById('previewCard').innerHTML = html;
        }

        // Update all outputs
        function updateOutputs() {
            document.getElementById('jsonOutput').textContent = generateJSON();
            updatePreview();
        }

        // Add debug message to UI
        function addDebugMessage(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600';
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            debugInfo.innerHTML = `<p class="${color}">[${timestamp}] ${icon} ${message}</p>` + debugInfo.innerHTML;
        }

        // Fetch metadata from URL
        async function fetchMetadata(url) {
            if (!url || !url.startsWith('http')) return;
            
            isLoading = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('btnRefresh').disabled = true;

            console.log('Fetching metadata from:', url);
            addDebugMessage(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å: ${url}`);

            try {
                // Try Method 1: Microlink API
                try {
                    console.log('Trying Microlink API...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Microlink API...');
                    
                    const microlinkUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
                    const response = await fetch(microlinkUrl);
                    
                    console.log('Microlink response status:', response.status);
                    addDebugMessage(`Microlink API status: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Microlink data:', result);
                        const data = result.data;
                        
                        if (data) {
                            let imageFound = false;
                            let descriptionFound = false;
                            
                            if (data.image?.url || data.logo?.url) {
                                document.getElementById('image').value = data.image?.url || data.logo?.url;
                                imageFound = true;
                                console.log('Image found:', data.image?.url || data.logo?.url);
                                addDebugMessage(`‡∏†‡∏≤‡∏û: ${data.image?.url || data.logo?.url}`, 'success');
                            }
                            
                            if (data.description) {
                                document.getElementById('keysum').value = data.description;
                                descriptionFound = true;
                                console.log('Description found:', data.description);
                                addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${data.description.substring(0, 50)}...`, 'success');
                            }
                            
                            // For title, need to get h1 from actual HTML - continue to AllOrigins
                            if (imageFound || descriptionFound) {
                                console.log('Got image/description from Microlink, will get h1 from HTML');
                                addDebugMessage('‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏û/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á h1 ‡∏à‡∏≤‡∏Å HTML...', 'info');
                            }
                        }
                    }
                } catch (e) {
                    console.log('‚ùå Microlink API error:', e.message);
                    addDebugMessage(`Microlink API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // Try Method 2: LinkPreview API for image and description
                try {
                    console.log('Trying LinkPreview API...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ LinkPreview API...');
                    
                    const linkPreviewUrl = `https://api.linkpreview.net/?q=${encodeURIComponent(url)}`;
                    const response = await fetch(linkPreviewUrl);
                    
                    console.log('LinkPreview response status:', response.status);
                    addDebugMessage(`LinkPreview API status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('LinkPreview data:', data);
                        
                        if (data.image && !document.getElementById('image').value) {
                            document.getElementById('image').value = data.image;
                            console.log('Image found:', data.image);
                            addDebugMessage(`‡∏†‡∏≤‡∏û: ${data.image}`, 'success');
                        }
                        if (data.description && !document.getElementById('keysum').value) {
                            document.getElementById('keysum').value = data.description;
                            console.log('Description found:', data.description);
                            addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${data.description.substring(0, 50)}...`, 'success');
                        }
                    }
                } catch (e) {
                    console.log('‚ùå LinkPreview API error:', e.message);
                    addDebugMessage(`LinkPreview API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // ALWAYS try Method 3: AllOrigins to get h1 tag for title
                try {
                    console.log('Trying AllOrigins proxy...');
                    addDebugMessage('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ AllOrigins Proxy...');
                    
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    console.log('AllOrigins response status:', response.status);
                    addDebugMessage(`AllOrigins status: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const html = result.contents;
                        
                        // Parse HTML to extract meta tags
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        let updated = false;
                        
                        // Get h1 first (priority), then fallback to other sources
                        const h1Text = doc.querySelector('h1')?.textContent?.trim();
                        const ogTitle = doc.querySelector('meta[property="og:title"]')?.content || 
                                       doc.querySelector('meta[name="twitter:title"]')?.content ||
                                       doc.querySelector('title')?.textContent;
                        
                        const titleToUse = h1Text || ogTitle;
                        
                        const ogImage = doc.querySelector('meta[property="og:image"]')?.content || 
                                       doc.querySelector('meta[name="twitter:image"]')?.content;
                        const ogDescription = doc.querySelector('meta[property="og:description"]')?.content ||
                                             doc.querySelector('meta[name="twitter:description"]')?.content ||
                                             doc.querySelector('meta[name="description"]')?.content;
                        
                        if (ogImage && !document.getElementById('image').value) {
                            document.getElementById('image').value = ogImage;
                            updated = true;
                            console.log('Image found:', ogImage);
                            addDebugMessage(`‡∏†‡∏≤‡∏û: ${ogImage}`, 'success');
                        }
                        if (titleToUse) {
                            document.getElementById('title').value = titleToUse;
                            updated = true;
                            const source = h1Text ? 'h1' : 'meta';
                            console.log(`Title found from ${source}:`, titleToUse);
                            addDebugMessage(`‡∏ä‡∏∑‡πà‡∏≠ (‡∏à‡∏≤‡∏Å ${source}): ${titleToUse}`, 'success');
                        }
                        if (ogDescription && !document.getElementById('keysum').value) {
                            document.getElementById('keysum').value = ogDescription;
                            updated = true;
                            console.log('Description found:', ogDescription);
                            addDebugMessage(`‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${ogDescription.substring(0, 50)}...`, 'success');
                        }
                        
                        if (updated) {
                            updateOutputs();
                            console.log('‚úÖ Successfully fetched metadata from AllOrigins');
                            addDebugMessage('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å AllOrigins Proxy', 'success');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('‚ùå AllOrigins proxy error:', e.message);
                    addDebugMessage(`AllOrigins Proxy ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, 'error');
                }

                // Check if we got any data at all before showing error
                const hasImage = document.getElementById('image').value;
                const hasTitle = document.getElementById('title').value;
                const hasDescription = document.getElementById('keysum').value;
                
                if (hasImage || hasTitle || hasDescription) {
                    updateOutputs();
                    addDebugMessage('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    return;
                }

                console.log('‚ùå All methods failed - no data retrieved');
                addDebugMessage('‚ùå ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á', 'error');
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n1. ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ h1 ‡∏´‡∏£‡∏∑‡∏≠ meta tags\n2. ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Ñ API requests\n3. API ‡∏°‡∏µ rate limit\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á\n\n‡∏î‡∏π Debug Info ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
                
            } finally {
                isLoading = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('btnRefresh').disabled = false;
            }
        }

        // Event listeners
        document.getElementById('btnArticle').addEventListener('click', function() {
            templateType = 'article';
            this.className = 'px-8 py-3 rounded-lg font-semibold transition-all bg-purple-600 text-white shadow-md';
            document.getElementById('btnOutlook').className = 'px-8 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200';
            document.getElementById('keysumContainer').style.display = 'block';
            updateOutputs();
        });

        document.getElementById('btnOutlook').addEventListener('click', function() {
            templateType = 'outlook';
            this.className = 'px-8 py-3 rounded-lg font-semibold transition-all bg-amber-600 text-white shadow-md';
            document.getElementById('btnArticle').className = 'px-8 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200';
            document.getElementById('keysumContainer').style.display = 'none';
            updateOutputs();
        });

        document.getElementById('weblink').addEventListener('input', function(e) {
            if (e.target.value) {
                fetchMetadata(e.target.value);
            }
        });

        document.getElementById('btnRefresh').addEventListener('click', function() {
            const url = document.getElementById('weblink').value;
            if (url) {
                fetchMetadata(url);
            }
        });

        document.getElementById('title').addEventListener('input', updateOutputs);
        document.getElementById('image').addEventListener('input', updateOutputs);
        document.getElementById('date').addEventListener('input', updateOutputs);
        document.getElementById('keysum').addEventListener('input', updateOutputs);

        document.getElementById('btnCopy').addEventListener('click', function() {
            const jsonOutput = generateJSON();
            navigator.clipboard.writeText(jsonOutput).then(() => {
                const icon = this.querySelector('i');
                const text = document.getElementById('copyText');
                
                icon.setAttribute('data-lucide', 'check');
                text.textContent = 'Copied!';
                lucide.createIcons();
                
                setTimeout(() => {
                    icon.setAttribute('data-lucide', 'copy');
                    text.textContent = 'Copy';
                    lucide.createIcons();
                }, 2000);
            });
        });

        // Initial render
        updateOutputs();
    </script>
</body>
</html>
