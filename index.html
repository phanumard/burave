<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Flex Message Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Lucide Icons as inline SVG components
        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
            </svg>
        );

        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        );

        function FlexMessageGenerator() {
            // Auto generate date in DDMMYYYY format
            const getTodayDate = () => {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                return `${day}${month}${year}`;
            };

            const [templateType, setTemplateType] = useState('article');
            const [formData, setFormData] = useState({
                title: '',
                image: '',
                weblink: '',
                keysum: '',
                date: getTodayDate()
            });
            
            const [copied, setCopied] = useState(false);
            const [isLoadingImage, setIsLoadingImage] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));

                // Auto-fetch image when weblink changes
                if (name === 'weblink' && value) {
                    fetchImageFromUrl(value);
                }
            };

            const fetchImageFromUrl = async (url) => {
                if (!url || !url.startsWith('http')) return;
                
                setIsLoadingImage(true);
                try {
                    const response = await fetch(url);
                    const html = await response.text();
                    
                    // Parse HTML to find Open Graph image or other meta images
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract image
                    const ogImage = doc.querySelector('meta[property="og:image"]')?.content ||
                                    doc.querySelector('meta[name="og:image"]')?.content ||
                                    doc.querySelector('meta[property="twitter:image"]')?.content ||
                                    doc.querySelector('meta[name="twitter:image"]')?.content ||
                                    doc.querySelector('meta[itemprop="image"]')?.content;
                    
                    // Extract title
                    const ogTitle = doc.querySelector('meta[property="og:title"]')?.content ||
                                    doc.querySelector('meta[name="og:title"]')?.content ||
                                    doc.querySelector('meta[property="twitter:title"]')?.content ||
                                    doc.querySelector('meta[name="twitter:title"]')?.content ||
                                    doc.querySelector('title')?.textContent ||
                                    '';
                    
                    // Extract description
                    const ogDescription = doc.querySelector('meta[property="og:description"]')?.content ||
                                        doc.querySelector('meta[name="og:description"]')?.content ||
                                        doc.querySelector('meta[property="twitter:description"]')?.content ||
                                        doc.querySelector('meta[name="twitter:description"]')?.content ||
                                        doc.querySelector('meta[name="description"]')?.content ||
                                        doc.querySelector('meta[itemprop="description"]')?.content ||
                                        '';
                    
                    // Update form data with extracted information
                    setFormData(prev => ({
                        ...prev,
                        image: ogImage || prev.image,
                        title: ogTitle || prev.title,
                        keysum: ogDescription || prev.keysum
                    }));
                } catch (error) {
                    console.error('Error fetching data:', error);
                } finally {
                    setIsLoadingImage(false);
                }
            };

            const getWebLinkWithUTM = () => {
                const link = formData.weblink || "[weblink]";
                if (link === "[weblink]") return link;
                
                const utmParams = "?utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA";
                // Check if URL already has query parameters
                if (link.includes('?')) {
                    return link + "&utm_source=EIC_LINEOA&utm_medium=EIC_LINEOA";
                }
                return link + utmParams;
            };

            const getImageUrl = () => {
                if (!formData.image) return "[image]";
                
                // If image is already a full URL, use it directly
                if (formData.image.startsWith('http')) {
                    return formData.image;
                }
                
                // Otherwise, use GitHub repository path
                return `https://raw.githubusercontent.com/scbeic/sharetarget2/main/${formData.image}`;
            };

            const generateArticleJSON = () => {
                return [{
                    "type": "flex",
                    "altText": formData.title || "[title]",
                    "contents": {
                        "type": "bubble",
                        "size": "giga",
                        "hero": {
                            "type": "image",
                            "url": getImageUrl(),
                            "size": "full",
                            "aspectRatio": "20:14",
                            "aspectMode": "cover",
                            "action": {
                                "type": "uri",
                                "uri": getWebLinkWithUTM()
                            }
                        },
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "Key summary",
                                    "weight": "bold",
                                    "size": "lg"
                                },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "margin": "lg",
                                    "spacing": "sm",
                                    "contents": [
                                        {
                                            "type": "box",
                                            "layout": "baseline",
                                            "spacing": "sm",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": formData.keysum || "[keysum]",
                                                    "wrap": true,
                                                    "color": "#666666",
                                                    "size": "sm",
                                                    "flex": 5
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "height": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "Read more",
                                        "uri": getWebLinkWithUTM()
                                    },
                                    "color": "#4e2e79"
                                },
                                {
                                    "type": "button",
                                    "style": "secondary",
                                    "height": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "Share",
                                        "uri": `https://liff.line.me/1657155025-N4RBzQGX?messages=https://raw.githubusercontent.com/scbeic/sharetarget2/main/messages${formData.date || "[date]"}.json`
                                    }
                                },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "contents": [],
                                    "margin": "sm"
                                }
                            ],
                            "flex": 0
                        }
                    }
                }];
            };

            const generateOutlookJSON = () => {
                return [{
                    "type": "flex",
                    "altText": formData.title || "[title]",
                    "contents": {
                        "type": "bubble",
                        "size": "giga",
                        "hero": {
                            "type": "image",
                            "url": getImageUrl(),
                            "size": "full",
                            "aspectRatio": "25:28",
                            "aspectMode": "cover",
                            "action": {
                                "type": "uri",
                                "uri": getWebLinkWithUTM()
                            }
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "height": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "Read more",
                                        "uri": formData.weblink || "[weblink]"
                                    },
                                    "color": "#bd8c66"
                                },
                                {
                                    "type": "button",
                                    "style": "secondary",
                                    "height": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "Share",
                                        "uri": `https://liff.line.me/1657155025-N4RBzQGX?messages=https://raw.githubusercontent.com/scbeic/sharetarget2/main/messages${formData.date || "[date]"}.json`
                                    }
                                },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "contents": [],
                                    "margin": "sm"
                                }
                            ],
                            "flex": 0,
                            "backgroundColor": "#1f172b"
                        }
                    }
                }];
            };

            const generateJSON = () => {
                const json = templateType === 'article' ? generateArticleJSON() : generateOutlookJSON();
                return JSON.stringify(json, null, 2);
            };

            const copyToClipboard = () => {
                const jsonOutput = generateJSON();
                navigator.clipboard.writeText(jsonOutput).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">LINE Flex Message Generator</h1>
                            <p className="text-gray-600">กรอกข้อมูลเพื่อสร้าง Flex Message JSON</p>
                        </div>

                        {/* Template Type Selector */}
                        <div className="mb-8 flex justify-center">
                            <div className="bg-white rounded-lg shadow-lg p-2 inline-flex gap-2">
                                <button
                                    onClick={() => setTemplateType('article')}
                                    className={`px-8 py-3 rounded-lg font-semibold transition-all ${
                                        templateType === 'article'
                                            ? 'bg-purple-600 text-white shadow-md'
                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                    }`}
                                >
                                    Article
                                </button>
                                <button
                                    onClick={() => setTemplateType('outlook')}
                                    className={`px-8 py-3 rounded-lg font-semibold transition-all ${
                                        templateType === 'outlook'
                                            ? 'bg-amber-600 text-white shadow-md'
                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                    }`}
                                >
                                    Outlook
                                </button>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-8">
                            {/* Form Section */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800">กรอกข้อมูล</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Web Link
                                        </label>
                                        <input
                                            type="url"
                                            name="weblink"
                                            value={formData.weblink}
                                            onChange={handleChange}
                                            placeholder="https://example.com/article"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            ระบบจะดึงภาพหน้าปก, ชื่อบทความ และคำอธิบายอัตโนมัติ
                                        </p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Title
                                        </label>
                                        <input
                                            type="text"
                                            name="title"
                                            value={formData.title}
                                            onChange={handleChange}
                                            placeholder="จะดึงอัตโนมัติจาก Web Link หรือกรอกเอง"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Image URL
                                            {isLoadingImage && (
                                                <span className="ml-2 text-xs text-blue-600">กำลังโหลดรูปภาพ...</span>
                                            )}
                                        </label>
                                        <input
                                            type="text"
                                            name="image"
                                            value={formData.image}
                                            onChange={handleChange}
                                            placeholder="จะดึงอัตโนมัติจาก Web Link หรือใส่ URL / ชื่อไฟล์เอง"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            disabled={isLoadingImage}
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            อัตโนมัติ: ดึงจาก Web Link | ใส่เอง: URL เต็ม หรือ ชื่อไฟล์ใน GitHub
                                        </p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Date
                                        </label>
                                        <input
                                            type="text"
                                            name="date"
                                            value={formData.date}
                                            onChange={handleChange}
                                            placeholder="01042025"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            รูปแบบ: DDMMYYYY (ตั้งค่าอัตโนมัติเป็นวันที่ปัจจุบัน)
                                        </p>
                                    </div>

                                    {templateType === 'article' && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Key Summary
                                            </label>
                                            <textarea
                                                name="keysum"
                                                value={formData.keysum}
                                                onChange={handleChange}
                                                placeholder="จะดึงอัตโนมัติจาก Web Link หรือกรอกเอง"
                                                rows="4"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Output Section */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-semibold text-gray-800">JSON Output</h2>
                                    <button
                                        onClick={copyToClipboard}
                                        className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                    >
                                        {copied ? (
                                            <>
                                                <CheckIcon />
                                                Copied!
                                            </>
                                        ) : (
                                            <>
                                                <CopyIcon />
                                                Copy
                                            </>
                                        )}
                                    </button>
                                </div>
                                
                                <div className="bg-gray-900 rounded-lg p-4 overflow-auto max-h-[600px]">
                                    <pre className="text-green-400 text-sm font-mono">
                                        {generateJSON()}
                                    </pre>
                                </div>
                            </div>
                        </div>

                        {/* Preview Section */}
                        <div className="mt-8 bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-semibold mb-4 text-gray-800">Preview</h2>
                            <div className="flex justify-center">
                                <div className="w-full max-w-sm bg-white border border-gray-200 rounded-lg overflow-hidden shadow-md">
                                    {/* Hero Image */}
                                    <div className="relative bg-gray-200" style={{ paddingBottom: templateType === 'article' ? '70%' : '112%' }}>
                                        {formData.image ? (
                                            <img 
                                                src={getImageUrl()}
                                                alt={formData.title || "Preview"}
                                                className="absolute inset-0 w-full h-full object-cover"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.parentElement.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-400">Image Preview</div>';
                                                }}
                                            />
                                        ) : (
                                            <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                                                Image Preview
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Body - Only for Article */}
                                    {templateType === 'article' && (
                                        <div className="p-4">
                                            <h3 className="font-bold text-lg mb-3">Key summary</h3>
                                            <p className="text-gray-600 text-sm">
                                                {formData.keysum || "[keysum]"}
                                            </p>
                                        </div>
                                    )}
                                    
                                    {/* Footer */}
                                    <div className={`p-4 space-y-2 ${templateType === 'outlook' ? 'bg-gray-900' : ''}`}>
                                        <button className={`w-full py-2 text-white rounded font-medium transition-colors ${
                                            templateType === 'article' 
                                                ? 'bg-purple-700 hover:bg-purple-800' 
                                                : 'bg-amber-700 hover:bg-amber-800'
                                        }`}>
                                            Read more
                                        </button>
                                        <button className="w-full py-2 bg-gray-200 text-gray-700 rounded font-medium hover:bg-gray-300 transition-colors">
                                            Share
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlexMessageGenerator />);
    </script>
</body>
</html>
